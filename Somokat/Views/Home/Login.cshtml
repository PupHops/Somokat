@{

    ViewBag.Title = "Login";



}

<head>
    <link rel="stylesheet" href="~/lib/bootstrap/dist/css/bootstrap.min.css" />

    <link rel="stylesheet" href="~/css/Style.css" />
</head>

<div class="full-screen-div">
    <div class="containerrr">
        <h2>Логин</h2>
        <input id="inputPhone" value="+7(___)___-__-__"/>
        <input type="password" id="inputPassword" />
        <input class="button" type="submit" onclick="loginUser()" value="Отправить" />
        <a href="https://localhost:7099/Home/Registration">Нету аккаунта?</a>
    </div>
</div>
<script>

    let inputPhone = document.getElementById("inputPhone");
    inputPhone.oninput = () => phoneMask(inputPhone)
    function phoneMask(inputEl) {
        let patStringArr = "+7(___)___-__-__".split('');
        let arrPush = [3, 4, 5, 7, 8, 9, 11, 12, 14, 15]
        let val = inputEl.value;
        let arr = val.replace(/\D+/g, "").split('').splice(1);
        let n;
        let ni;
        arr.forEach((s, i) => {
            n = arrPush[i];
            patStringArr[n] = s
            ni = i
        });
        arr.length < 10 ? inputEl.style.color = 'red' : inputEl.style.color = 'green';
        inputEl.value = patStringArr.join('');
        n ? inputEl.setSelectionRange(n + 1, n + 1) : inputEl.setSelectionRange(17, 17)
    }
</script>
<script>

    window.onload = function () {
        var phoneNumber = localStorage.getItem('phoneNumber');

        console.log(phoneNumber);
        if (phoneNumber != null) {
            window.location.href = 'https://localhost:7099/Home/';
        } 


    };

    function loginUser() {
        var password = document.getElementById("inputPassword").value;
        var phoneNumber = document.getElementById("inputPhone").value;
        phoneNumber = phoneNumber.replace(/\D/g, '');
        var data = {
            phoneNumber, password
        };
        console.log(data);

        $.ajax({
            url: 'https://localhost:7209/Authorization/login',
            method: 'POST',
            contentType: 'application/json', // Установка заголовка Content-Type
            data: JSON.stringify(data),
            success: function (response, textStatus, xhr) {
                localStorage.setItem('phoneNumber', phoneNumber);
                if (xhr.status === 200) {

                    localStorage.setItem('balance', JSON.stringify(response.balance || 0));
                    localStorage.setItem('Bonus', JSON.stringify(response.bonus || 0));
                    localStorage.setItem('userId', JSON.stringify(response.id));
                    localStorage.setItem('name', JSON.stringify(response.name));
                    localStorage.setItem('surname', JSON.stringify(response.surname));

                   window.location.href = 'https://localhost:7099/Home/';
                } else {
                    alert('Error: ' + xhr.status);
                }
            },
            error: function () {
                alert('Пользователь не найден.');
            }
        });
        

       
    }
</script>
